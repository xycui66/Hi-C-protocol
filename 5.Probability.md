
### Power by Zhu Qianshu
#### 根据40Kb分辨率互作矩阵拆分interchrom和intrachrom
Input_matrix使用HiC-Pro结果文件中的"SAMPLE_Resolution.matrix"\
Hic_ann=/home/share/HiC-Pro-annotations/
~~~
for i in *matrix;do o=${i##*/};echo $o; 
awk -v OFS="\t" -v intra=${o/matrix/intra} -v inter=${o/matrix/inter} 'NR==FNR{if($4>a[$1]){a[$1]=$4}} 
NR>FNR{for(i in a){if($1<=a[i]&&$2>a[i]){print $0 > inter;next}}; print $0 > intra}' $Hic_ann/40000_mm10.bed $i & 
done
~~~
### 将所有的等距的互作数加和，距离以40K为单位记录
~~~
for j in *intra;do awk -v OFS="\t" -v OFS="\t" '{a[$2-$1]+=$3} END{for(i in a)print i,a[i]}' $j| sort -k1n,1 >${j/intra/tab} & done
~~~
### Rscript
~~~
#read and merge files
flist <- list.files(path = IntraDir,pattern = ".tab",full.names = T)
nlist <- c("Sample1","Sample2","Sample3")
factor_levels=c("Sample1","Sample2","Sample3","Ps")
res= 40000
input = data.frame(distance = 1:10000, Ps = (1:10000)^-1) 

for(i in 1:length(flist)){
  temp.ps = read.table(flist[i],sep = "\t",header = F)
  colnames(temp.ps) = c("distance",nlist[i])
  temp.ps[,1] = temp.ps[,1] + 1
  print(length(rownames(temp.ps)))
  input = merge(input,temp.ps,by = "distance",all=TRUE)
  print(length(rownames(input)))
}

#wash and norm data.ps
data.ps = input

data.ps[is.na(data.ps)] = 0.0

data.ps[,1] = data.ps[,1]*res  #convert the unit of distance to bp
# normalize the total probability to 1
data.ps[,-1] = apply(data.ps[,-1],2,function(x) x/sum(x))
#each bin was res multiple
data.ps[,-1] = data.ps[,-1]/res
#select range
data.ps = data.ps[which(data.ps$distance >= 1e5 & data.ps$distance <= 3e8),]


#for scale_x_log plot

# convert the probability to log10
#data.ps = log10(data.ps)
data.ps$distance = log10(data.ps$distance)

# setting groups to average point/distance in the region
#data.ps$group = round(data.ps$distance, digits = 2)
step = 0.05                    #set a step for plot point of x   #0.05 is the best
data.ps$group = round(data.ps$distance/step)

data.ps[which(data.ps == -Inf,arr.ind = T)] = NA

probability=aggregate(.~group,data=data.ps,mean)
probability$distance = as.numeric(probability$group) * step    #probability un-log

# for plor wide to long
logMatrix = probability[,-1]
logMatrix[,-1] = log10(logMatrix[,-1])

melt.ps = melt(logMatrix,id.vars = "distance",variable.name = "Sample")
melt.ps$Sample = factor(melt.ps$Sample, levels=factor_levels)


######plot line#####
ggplot(data=melt.ps,mapping =  aes(x=distance,y=value,colour = Sample)) + 
  geom_line(size=1) + 
  theme_classic() + xlab("Distance(log10)") + ylab("Probability (log10)") + 
  annotation_logticks()  +
  scale_color_manual(values = c(brewer.pal(3,"Set2"),"darkgrey")) +
  theme(legend.position = c(0.2, 0.4),legend.background = element_rect(fill=NA))
~~~